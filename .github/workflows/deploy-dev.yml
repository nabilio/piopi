name: Deploy DEV to VPS

on:
  push:
    branches: ["dev"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add VPS host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via SSH to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.VPS_HOST }}
          username: ${{ vars.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # Charger NVM si prÃ©sent (shell non interactif)
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
              nvm use --lts >/dev/null 2>&1 || nvm use >/dev/null 2>&1 || true
            fi

            export PATH="/usr/local/bin:/usr/bin:$PATH"
            echo "Node: $(node -v) | NPM: $(npm -v)"

            APP_DIR=/home/adminio/htdocs/lapsi.online
            PROC_NAME=piopi-dev
            PORT=3001

            cd "$APP_DIR"
            git fetch origin dev
            git reset --hard origin/dev

            npm ci
            npm run build

            # PM2 / serve
            command -v pm2 >/dev/null 2>&1 || npm i -g pm2
            command -v serve >/dev/null 2>&1 || npm i -g serve

            pm2 delete "$PROC_NAME" || true
            pm2 start "serve -s ./dist -l $PORT" --name "$PROC_NAME"
            pm2 save

            # Pas de reload nginx en DEV
            echo "Skip nginx reload (not needed for dev)"
